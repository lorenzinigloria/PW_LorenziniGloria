-- Costruzione della Vista Analitica Globale
CREATE OR REPLACE VIEW v_export_profilo_acn AS
SELECT 
    s.codice_acn AS "Codice_Servizio_ACN",
    s.nome_servizio AS "Servizio_Erogato",
    s.livello_impatto AS "Impatto_Nazionale",
    s.rto_ore AS "RTO_Ore",
    r.nome_cognome AS "Referente_Designato",
    a.identificativo_logico AS "Identificativo_Asset_Critico",
    a.tipo_asset AS "Tipologia_Asset",
    d.tipo_relazione AS "Relazione_Supporto",
    COALESCE(f.ragione_sociale, 'In-House') AS "Fornitore_Outsourcing",
    COALESCE(f.stato_conformita, 'N/A') AS "Conformita_NIS2_Vendor"
FROM anagrafica_servizi_critici s
JOIN ruoli_responsabilita r ON s.id_responsabile = r.id_responsabile
JOIN dipendenze_asset_servizio d ON s.id_servizio = d.id_servizio
JOIN inventario_asset_ict a ON d.id_asset = a.id_asset
LEFT JOIN fornitori_terze_parti f ON a.id_fornitore = f.id_fornitore;

-- Query filtrata per uno specifico servizio (Es. Ispezione su nodo Finanziario)
-- SELECT * FROM v_export_profilo_acn WHERE "Codice_Servizio_ACN" = 'FIN-001';

-- Serializzazione su disco nel formato richiesto dalle autorit√†
COPY (SELECT * FROM v_export_profilo_acn) 
TO '/tmp/export_profilo_acn_2025.csv' 
WITH (FORMAT CSV, HEADER TRUE, DELIMITER ';', ENCODING 'UTF8');