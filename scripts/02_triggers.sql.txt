-- Struttura dati per l'Audit
CREATE TABLE audit_log_asset (
    id_log SERIAL PRIMARY KEY,
    id_asset INT NOT NULL,
    vecchio_fornitore INT,
    nuovo_fornitore INT,
    data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    azione VARCHAR(50)
);

-- Funzione procedurale per il controllo delle transizioni di stato
CREATE OR REPLACE FUNCTION log_asset_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.id_fornitore IS DISTINCT FROM NEW.id_fornitore THEN
        INSERT INTO audit_log_asset (id_asset, vecchio_fornitore, nuovo_fornitore, azione)
        VALUES (OLD.id_asset, OLD.id_fornitore, NEW.id_fornitore, 'UPDATE_SUPPLY_CHAIN');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger agganciato alla tabella tecnica
CREATE TRIGGER trg_storico_modifiche_asset
AFTER UPDATE ON inventario_asset_ict
FOR EACH ROW
EXECUTE FUNCTION log_asset_changes();